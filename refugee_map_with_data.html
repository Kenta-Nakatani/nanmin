<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç•Œé›£æ°‘åˆ†å¸ƒãƒãƒƒãƒ— 2020-2024 - å®Ÿãƒ‡ãƒ¼ã‚¿ç‰ˆ</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: none;
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        .content {
            padding: 20px;
            max-width: none;
            width: 100%;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin: 0 0 8px 0;
            font-size: 1.2em;
        }
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            margin: 8px 0;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            font-size: 0.9em;
            opacity: 0.9;
        }
        .map-container {
            margin: 10px 0;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            max-width: 100vw;
        }
        .map-container > div {
            width: 100vw;
            max-width: 100vw;
        }
        .flow-container {
            margin: 10px 0;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            max-width: 100vw;
        }
        .flow-container > div {
            width: 100vw;
            max-width: 100vw;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }
        .loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #74b9ff;
        }
        .info-panel h3 {
            margin-top: 0;
            color: #2d3436;
        }
        .info-panel ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info-panel li {
            margin: 5px 0;
        }
        .charts-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin: 20px 0;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
        }
        .chart-container h3 {
            margin-top: 0;
            text-align: center;
            color: #2d3436;
        }
        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .map-container > div,
            .flow-container > div {
                max-width: 100%;
            }
            #world-map,
            #arc-flow {
                height: 500px !important;
                width: 100vw !important;
                max-width: 100vw !important;
            }
        }
        @media (max-width: 1200px) {
            .map-container > div,
            .flow-container > div {
                max-width: 100%;
            }
            #world-map,
            #arc-flow {
                height: 600px !important;
                width: 100vw !important;
                max-width: 100vw !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ ä¸–ç•Œé›£æ°‘åˆ†å¸ƒãƒãƒƒãƒ—</h1>
            <p>2020-2024å¹´ ã‚°ãƒ­ãƒ¼ãƒãƒ«é›£æ°‘ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ç‰ˆï¼‰</p>
        </div>
        
        <div class="content">
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <button id="tab-map" class="tab-btn" style="padding: 10px 20px; border-radius: 8px; border: none; background: #0984e3; color: white; font-size: 1em; cursor: pointer;">å—ã‘å…¥ã‚Œåˆ†å¸ƒãƒ»çµ±è¨ˆ</button>
                <button id="tab-flow" class="tab-btn" style="padding: 10px 20px; border-radius: 8px; border: none; background: #636e72; color: white; font-size: 1em; cursor: pointer;">ç§»å‹•ãƒ•ãƒ­ãƒ¼</button>
            </div>
            <div class="info-panel">
                <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦</h3>
                <p>ã“ã®ãƒãƒƒãƒ—ã¯ã€HDX (Humanitarian Data Exchange) HAPIã‹ã‚‰å–å¾—ã—ãŸ2020å¹´ã‹ã‚‰2024å¹´ã¾ã§ã®ä¸–ç•Œã®é›£æ°‘ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚</p>
                <ul>
                    <li><strong>ãƒ‡ãƒ¼ã‚¿æœŸé–“:</strong> 2020å¹´1æœˆ1æ—¥ - 2024å¹´12æœˆ31æ—¥</li>
                    <li><strong>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</strong> HDX HAPI Refugees Global Dataset</li>
                    <li><strong>å«ã¾ã‚Œã‚‹æƒ…å ±:</strong> å‡ºèº«å›½ã€é¿é›£å…ˆå›½ã€å¹´é½¢å±¤ã€æ€§åˆ¥ã€äººå£æ•°</li>
                    <li><strong>ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:</strong> ç´„60ä¸‡ãƒ¬ã‚³ãƒ¼ãƒ‰</li>
                </ul>
                <p><strong>ğŸ“‹ è¡¨ç¤ºå†…å®¹:</strong></p>
                <ul>
                    <li><strong>å—ã‘å…¥ã‚Œåˆ†å¸ƒãƒ»çµ±è¨ˆ:</strong> å„å›½ã®é›£æ°‘å—ã‘å…¥ã‚Œæ•°ã€å¹´é½¢ãƒ»æ€§åˆ¥åˆ¥çµ±è¨ˆã€å¹´åˆ¥æ¨ç§»</li>
                    <li><strong>ç§»å‹•ãƒ•ãƒ­ãƒ¼:</strong> å‡ºèº«å›½ã‹ã‚‰é¿é›£å…ˆå›½ã¸ã®ç§»å‹•ãƒ«ãƒ¼ãƒˆï¼ˆä¸Šä½10ä»¶ï¼‰</li>
                </ul>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·é›£æ°‘æ•°</h3>
                    <div class="number" id="total-refugees">-</div>
                    <p>æœ€æ–°å¹´</p>
                </div>
                <div class="stat-card">
                    <h3>å¯¾è±¡å›½æ•°</h3>
                    <div class="number" id="total-countries">-</div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å›½</p>
                </div>
                <div class="stat-card">
                    <h3>ãƒ‡ãƒ¼ã‚¿æœŸé–“</h3>
                    <div class="number" id="data-years">-</div>
                    <p>å¹´æ•°</p>
                </div>
                <div class="stat-card">
                    <h3>ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ</h3>
                    <div class="number" id="data-records">-</div>
                    <p>ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</p>
                </div>
                <div class="stat-card">
                    <h3>æœ€å¤§å—ã‘å…¥ã‚Œå›½</h3>
                    <div class="number" id="top-asylum">-</div>
                    <p>å›½ã‚³ãƒ¼ãƒ‰</p>
                </div>
                <div class="stat-card">
                    <h3>æœ€å¤§å‡ºèº«å›½</h3>
                    <div class="number" id="top-origin">-</div>
                    <p>å›½ã‚³ãƒ¼ãƒ‰</p>
                </div>
            </div>

            <div id="main-visualization">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <h3>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</h3>
                    <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
                </div>

                <div id="error-container" style="display: none;"></div>

                <div id="map-container" class="map-container" style="display: none;">
                    <div id="world-map" style="height: 700px; width: 100vw; max-width: 100vw; margin: 0; padding: 0;"></div>
                </div>

                <div class="charts-grid" id="charts-container" style="display: none;">
                    <div class="chart-container">
                        <h3>ğŸ“ˆ å¹´åˆ¥é›£æ°‘æ•°æ¨ç§»</h3>
                        <div id="yearly-chart" style="height: 400px;"></div>
                    </div>
                    <div class="chart-container">
                        <h3>ğŸ‘¥ å¹´é½¢å±¤åˆ¥åˆ†å¸ƒ</h3>
                        <div id="age-chart" style="height: 400px;"></div>
                    </div>
                    <div class="chart-container">
                        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æ€§åˆ¥åˆ¥åˆ†å¸ƒ</h3>
                        <div id="gender-chart" style="height: 400px;"></div>
                    </div>
                    <div class="chart-container">
                        <h3>ğŸ† ä¸Šä½10ã‚«å›½ï¼ˆé¿é›£å…ˆï¼‰</h3>
                        <div id="top-countries-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
            <div id="flow-visualization" style="display: none;">
                <div class="flow-container">
                    <div class="chart-container" style="width: 100vw; max-width: 100vw; margin: 0; padding: 10px;">
                        <h3>ğŸŒ å‡ºèº«å›½â†’é¿é›£å…ˆå›½ã®ç§»å‹•ãƒ•ãƒ­ãƒ¼ï¼ˆä¸Šä½10ï¼‰</h3>
                        <div id="arc-flow" style="height: 700px; width: 100vw; max-width: 100vw; margin: 0; padding: 0;"></div>
                    </div>
                </div>
            </div>

            <div class="info-panel">
                <h3>ğŸ¯ ãƒãƒƒãƒ—ã®ä½¿ã„æ–¹</h3>
                <ul>
                    <li><strong>ãƒ›ãƒãƒ¼:</strong> å›½ã«ãƒã‚¦ã‚¹ã‚’åˆã‚ã›ã‚‹ã¨è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                    <li><strong>ã‚ºãƒ¼ãƒ :</strong> ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§åœ°å›³ã‚’æ‹¡å¤§ãƒ»ç¸®å°ã§ãã¾ã™</li>
                    <li><strong>ãƒ‘ãƒ³:</strong> ãƒ‰ãƒ©ãƒƒã‚°ã§åœ°å›³ã‚’ç§»å‹•ã§ãã¾ã™</li>
                    <li><strong>è‰²ã®æ„å‘³:</strong> èµ¤è‰²ãŒæ¿ƒã„ã»ã©é›£æ°‘æ•°ãŒå¤šã„ã“ã¨ã‚’ç¤ºã—ã¾ã™</li>
                    <li><strong>ãƒ‡ãƒ¼ã‚¿:</strong> å®Ÿéš›ã®HDX HAPIãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let globalData = null;
        let processedData = null;

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        function loadCSVData() {
            Papa.parse('hdx_hapi_refugees_global_2020_2024.csv', {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + results.errors[0].message);
                        return;
                    }
                    
                    globalData = results.data;
                    processData();
                },
                error: function(error) {
                    showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
        function processData() {
            console.log('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’é–‹å§‹...');
            
            try {
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ2è¡Œç›®ãŒå®Ÿéš›ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
                const dataRows = globalData.slice(2);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–ï¼ˆãƒãƒƒãƒå‡¦ç†ã§ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–ï¼‰
                const processed = [];
                const batchSize = 1000;
                
                for (let i = 0; i < dataRows.length; i += batchSize) {
                    const batch = dataRows.slice(i, i + batchSize);
                    const processedBatch = batch.map(row => {
                        if (row.length < 17) return null;
                        
                        const population = parseFloat(row[11]) || 0;
                        if (population <= 0) return null;
                        
                        // å¹´é½¢ãƒ»æ€§åˆ¥ãŒã€Œall,allã€ã®è¡Œã‚’é™¤å¤–ï¼ˆãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
                        if (row[7] === 'all' && row[8] === 'all') return null;
                        
                        // ã‚¤ãƒ©ãƒ³ï¼ˆIRNï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ä¿¡é ¼æ€§ã®å•é¡Œã®ãŸã‚ï¼‰
                        if (row[0] === 'IRN' || row[3] === 'IRN') return null;
                        
                        return {
                            origin_code: row[0],
                            asylum_code: row[3],
                            population_group: row[6],
                            gender: row[7],
                            age_range: row[8],
                            population: population,
                            start_date: row[12],
                            end_date: row[13]
                        };
                    }).filter(item => item !== null);
                    
                    processed.push(...processedBatch);
                    
                    // é€²æ—è¡¨ç¤º
                    if (i % 10000 === 0) {
                        console.log(`å‡¦ç†é€²æ—: ${i}/${dataRows.length} (${Math.round(i/dataRows.length*100)}%)`);
                    }
                }

                processedData = processed;
                
                // å¹´ã‚’æŠ½å‡ºï¼ˆåŠ¹ç‡åŒ–ï¼‰
                const yearRegex = /(\d{4})/;
                processedData.forEach(item => {
                    const yearMatch = item.start_date.match(yearRegex);
                    item.year = yearMatch ? parseInt(yearMatch[1]) : null;
                });

                console.log(`å‡¦ç†å®Œäº†: ${processedData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿`);
                
                // çµ±è¨ˆæƒ…å ±æ›´æ–°ã‚’éåŒæœŸã§å®Ÿè¡Œ
                setTimeout(() => {
                    updateStats();
                    createVisualizations();
                }, 100);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStats() {
            if (!processedData || processedData.length === 0) return;

            try {
                const years = [...new Set(processedData.map(d => d.year).filter(y => y !== null && y !== undefined))];
                const latestYear = Math.max(...years);
                const latestData = processedData.filter(d => d.year === latestYear);
                
                if (latestData.length === 0) return;
                
                // å›½å†…é¿é›£æ°‘ã‚’é™¤å¤–ã—ã€äººå£æ•°ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®ã®ã¿
                const internationalRefugees = latestData.filter(d => 
                    d.origin_code !== d.asylum_code && 
                    d.population > 0
                );
                
                const totalRefugees = internationalRefugees.reduce((sum, d) => sum + (d.population || 0), 0);
                const uniqueCountries = new Set(internationalRefugees.map(d => d.asylum_code)).size;
                const uniqueYears = years.length;
                
                // é¿é›£å…ˆå›½åˆ¥é›†è¨ˆï¼ˆå›½å†…é¿é›£æ°‘ã‚’é™¤å¤–ã€äººå£æ•°>0ã®ã¿ï¼‰
                const asylumCounts = {};
                internationalRefugees.forEach(d => {
                    if (d.asylum_code && d.population > 0) {
                        asylumCounts[d.asylum_code] = (asylumCounts[d.asylum_code] || 0) + d.population;
                    }
                });
                
                // å‡ºèº«å›½åˆ¥é›†è¨ˆï¼ˆå›½å†…é¿é›£æ°‘ã‚’é™¤å¤–ã€äººå£æ•°>0ã®ã¿ï¼‰
                const originCounts = {};
                internationalRefugees.forEach(d => {
                    if (d.origin_code && d.population > 0) {
                        originCounts[d.origin_code] = (originCounts[d.origin_code] || 0) + d.population;
                    }
                });

                const topAsylum = Object.entries(asylumCounts)
                    .sort(([,a], [,b]) => b - a)[0];
                const topOrigin = Object.entries(originCounts)
                    .sort(([,a], [,b]) => b - a)[0];

                // DOMæ›´æ–°
                const totalRefugeesEl = document.getElementById('total-refugees');
                const totalCountriesEl = document.getElementById('total-countries');
                const dataYearsEl = document.getElementById('data-years');
                const dataRecordsEl = document.getElementById('data-records');
                const topAsylumEl = document.getElementById('top-asylum');
                const topOriginEl = document.getElementById('top-origin');

                if (totalRefugeesEl) totalRefugeesEl.textContent = totalRefugees.toLocaleString();
                if (totalCountriesEl) totalCountriesEl.textContent = uniqueCountries;
                if (dataYearsEl) dataYearsEl.textContent = uniqueYears;
                if (dataRecordsEl) dataRecordsEl.textContent = internationalRefugees.length.toLocaleString();
                if (topAsylumEl) topAsylumEl.textContent = topAsylum ? topAsylum[0] : '-';
                if (topOriginEl) topOriginEl.textContent = topOrigin ? topOrigin[0] : '-';

                console.log('çµ±è¨ˆæƒ…å ±æ›´æ–°å®Œäº†ï¼ˆå›½å†…é¿é›£æ°‘ãƒ»0å€¤ãƒ»ã‚¤ãƒ©ãƒ³é™¤å¤–ï¼‰');
                console.log(`å›½éš›é›£æ°‘æ•°: ${totalRefugees.toLocaleString()}äºº`);
                console.log(`æœ€å¤§å—ã‘å…¥ã‚Œå›½: ${topAsylum ? topAsylum[0] + ' (' + topAsylum[1].toLocaleString() + 'äºº)' : 'ãªã—'}`);
                console.log(`æœ€å¤§å‡ºèº«å›½: ${topOrigin ? topOrigin[0] + ' (' + topOrigin[1].toLocaleString() + 'äºº)' : 'ãªã—'}`);
                
                // ä¸Šä½5ã‚«å›½ã®è©³ç´°ã‚’è¡¨ç¤º
                console.log('ä¸Šä½5å—ã‘å…¥ã‚Œå›½:');
                Object.entries(asylumCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .forEach(([country, count], idx) => {
                        console.log(`${idx + 1}. ${country}: ${count.toLocaleString()}äºº`);
                    });
            } catch (error) {
                console.error('çµ±è¨ˆæƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å¯è¦–åŒ–ã‚’ä½œæˆ
        function createVisualizations() {
            if (!processedData || processedData.length === 0) return;

            try {
                const years = [...new Set(processedData.map(d => d.year).filter(y => y !== null && y !== undefined))];
                const latestYear = Math.max(...years);
                const latestData = processedData.filter(d => d.year === latestYear);
                
                if (latestData.length === 0) {
                    console.log('æœ€æ–°å¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // å›½å†…é¿é›£æ°‘ã‚’é™¤å¤–ã—ã€äººå£æ•°ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®ã®ã¿
                const internationalRefugees = latestData.filter(d => 
                    d.origin_code !== d.asylum_code && 
                    d.population > 0
                );

                console.log(`å¯è¦–åŒ–é–‹å§‹: ${latestYear}å¹´ã®å›½éš›é›£æ°‘ãƒ‡ãƒ¼ã‚¿ ${internationalRefugees.length}ä»¶`);

                // ä¸–ç•Œåœ°å›³
                createWorldMap(internationalRefugees);
                
                // å¹´åˆ¥æ¨ç§»
                createYearlyChart();
                
                // å¹´é½¢å±¤åˆ¥
                createAgeChart(internationalRefugees);
                
                // æ€§åˆ¥åˆ¥
                createGenderChart(internationalRefugees);
                
                // ä¸Šä½10ã‚«å›½
                createTopCountriesChart(internationalRefugees);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                document.getElementById('loading').style.display = 'none';
                document.getElementById('map-container').style.display = 'block';
                document.getElementById('charts-container').style.display = 'grid';
                
                console.log('å¯è¦–åŒ–å®Œäº†');
                
            } catch (error) {
                console.error('å¯è¦–åŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('å¯è¦–åŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ä¸–ç•Œåœ°å›³ã‚’ä½œæˆ
        function createWorldMap(data) {
            const asylumCounts = {};
            data.forEach(d => {
                asylumCounts[d.asylum_code] = (asylumCounts[d.asylum_code] || 0) + d.population;
            });

            const locations = Object.keys(asylumCounts);
            const z = Object.values(asylumCounts);
            const text = locations.map(code => `${code}<br>é›£æ°‘æ•°: ${asylumCounts[code].toLocaleString()}äºº`);

            const mapData = [{
                type: 'choropleth',
                locations: locations,
                z: z,
                text: text,
                locationmode: 'ISO-3',
                colorscale: [
                    [0, 'rgb(255,255,255)'],      // ç™½ï¼ˆå°‘ãªã„ï¼‰
                    [0.3, 'rgb(255,255,255)'],    // ç™½
                    [0.4, 'rgb(255,0,0)'],        // èµ¤ï¼ˆå¤šã„ï¼‰
                    [0.7, 'rgb(255,0,0)'],        // èµ¤
                    [0.8, 'rgb(128,0,128)'],      // ç´«ï¼ˆã‚ã¡ã‚ƒå¤šã„ï¼‰
                    [1, 'rgb(128,0,128)']         // ç´«
                ],
                autocolorscale: false,
                reversescale: false,
                marker: {
                    line: {
                        color: 'rgb(255,255,255)',
                        width: 1
                    }
                },
                colorbar: {
                    title: 'é›£æ°‘æ•°<br>ç™½:å°‘ãªã„ èµ¤:å¤šã„ ç´«:ã‚ã¡ã‚ƒå¤šã„',
                    thickness: 15,
                    len: 0.5,
                    x: 0.8,
                    y: 0.5
                }
            }];

            const layout = {
                title: {
                    text: 'ğŸŒ ä¸–ç•Œé›£æ°‘å—ã‘å…¥ã‚Œåˆ†å¸ƒãƒãƒƒãƒ— (é¿é›£å…ˆå›½åˆ¥)',
                    font: { size: 20, color: '#2d3436' },
                    x: 0.5
                },
                geo: {
                    scope: 'world',
                    projection: { type: 'mercator' },
                    showland: true,
                    landcolor: 'rgb(243, 243, 243)',
                    coastlinecolor: 'rgb(204, 204, 204)',
                    showocean: true,
                    oceancolor: 'rgb(230, 230, 250)',
                    showcountries: true,
                    countrycolor: 'rgb(255, 255, 255)',
                    showframe: false
                },
                margin: { l: 0, r: 0, t: 50, b: 0 },
                height: 700,
                width: null,
                autosize: true
            };

            Plotly.newPlot('world-map', mapData, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            });
        }

        // å¹´åˆ¥æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
        function createYearlyChart() {
            const yearlyTotals = {};
            processedData.forEach(d => {
                if (d.year && d.origin_code !== d.asylum_code && d.population > 0) { // å›½å†…é¿é›£æ°‘ã¨0å€¤ã‚’é™¤å¤–
                    yearlyTotals[d.year] = (yearlyTotals[d.year] || 0) + d.population;
                }
            });

            const years = Object.keys(yearlyTotals).sort();
            const totals = years.map(year => yearlyTotals[year]);

            const data = [{
                x: years,
                y: totals,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#2ecc71', width: 3 },
                marker: { size: 8, color: '#27ae60' },
                name: 'å¹´åˆ¥ç·æ•°'
            }];

            const layout = {
                title: 'å¹´åˆ¥å›½éš›é›£æ°‘æ•°æ¨ç§»',
                xaxis: { title: 'å¹´' },
                yaxis: { title: 'é›£æ°‘æ•°' },
                margin: { l: 80, r: 50, t: 60, b: 80 },
                font: { size: 14 }
            };

            Plotly.newPlot('yearly-chart', data, layout, { responsive: true });
        }

        // å¹´é½¢å±¤åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
        function createAgeChart(data) {
            const ageCounts = {};
            data.forEach(d => {
                ageCounts[d.age_range] = (ageCounts[d.age_range] || 0) + d.population;
            });

            const data_chart = [{
                x: Object.keys(ageCounts),
                y: Object.values(ageCounts),
                type: 'bar',
                marker: { color: '#f39c12' },
                name: 'å¹´é½¢å±¤åˆ¥'
            }];

            const layout = {
                title: 'å¹´é½¢å±¤åˆ¥é›£æ°‘æ•°',
                xaxis: { title: 'å¹´é½¢å±¤' },
                yaxis: { title: 'é›£æ°‘æ•°' },
                margin: { l: 80, r: 50, t: 60, b: 80 },
                font: { size: 14 }
            };

            Plotly.newPlot('age-chart', data_chart, layout, { responsive: true });
        }

        // æ€§åˆ¥åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
        function createGenderChart(data) {
            const genderCounts = {};
            data.forEach(d => {
                const gender = d.gender === 'f' ? 'å¥³æ€§' : 'ç”·æ€§';
                genderCounts[gender] = (genderCounts[gender] || 0) + d.population;
            });

            const data_chart = [{
                x: Object.keys(genderCounts),
                y: Object.values(genderCounts),
                type: 'bar',
                marker: { color: ['#e74c3c', '#3498db'] },
                name: 'æ€§åˆ¥åˆ¥'
            }];

            const layout = {
                title: 'æ€§åˆ¥åˆ¥é›£æ°‘æ•°',
                xaxis: { title: 'æ€§åˆ¥' },
                yaxis: { title: 'é›£æ°‘æ•°' },
                margin: { l: 80, r: 50, t: 60, b: 80 },
                font: { size: 14 }
            };

            Plotly.newPlot('gender-chart', data_chart, layout, { responsive: true });
        }

        // ä¸Šä½10ã‚«å›½ãƒãƒ£ãƒ¼ãƒˆ
        function createTopCountriesChart(data) {
            const asylumCounts = {};
            data.forEach(d => {
                asylumCounts[d.asylum_code] = (asylumCounts[d.asylum_code] || 0) + d.population;
            });

            const sortedCountries = Object.entries(asylumCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const data_chart = [{
                x: sortedCountries.map(([,count]) => count),
                y: sortedCountries.map(([code]) => code),
                type: 'bar',
                orientation: 'h',
                marker: { color: '#e74c3c' },
                name: 'ä¸Šä½10ã‚«å›½'
            }];

            const layout = {
                title: 'ä¸Šä½10ã‚«å›½ï¼ˆé¿é›£å…ˆï¼‰',
                xaxis: { title: 'é›£æ°‘æ•°' },
                yaxis: { title: 'å›½ã‚³ãƒ¼ãƒ‰' },
                margin: { l: 100, r: 50, t: 60, b: 80 },
                font: { size: 14 }
            };

            Plotly.newPlot('top-countries-chart', data_chart, layout, { responsive: true });
        }

        // ã‚¢ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åœ°å›³ä½œæˆ
        function createArcFlow() {
            if (!processedData || processedData.length === 0) return;
            
            try {
                const years = [...new Set(processedData.map(d => d.year).filter(y => y !== null && y !== undefined))];
                const latestYear = Math.max(...years);
                const latestData = processedData.filter(d => d.year === latestYear);
                
                if (latestData.length === 0) return;
                
                // å›½å†…é¿é›£æ°‘ã‚’é™¤å¤–ã—ã€äººå£æ•°ãŒ0ã‚ˆã‚Šå¤§ãã„ã‚‚ã®ã®ã¿
                const internationalRefugees = latestData.filter(d => d.origin_code !== d.asylum_code);
                
                console.log('ã‚¢ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆé–‹å§‹');
                
                // å‡ºèº«å›½â†’é¿é›£å…ˆå›½ã”ã¨ã«é›†è¨ˆ
                const flowCounts = {};
                internationalRefugees.forEach(d => {
                    if (d.origin_code && d.asylum_code && d.population > 0) {
                        const key = d.origin_code + 'â†’' + d.asylum_code;
                        flowCounts[key] = (flowCounts[key] || 0) + d.population;
                    }
                });
                
                // ä¸Šä½10ã®æµã‚Œã‚’æŠ½å‡º
                const topFlows = Object.entries(flowCounts)
                    .sort(([,a],[,b]) => b - a)
                    .slice(0, 10);
                
                console.log(`ä¸Šä½10ãƒ•ãƒ­ãƒ¼æŠ½å‡ºå®Œäº†: ${topFlows.length}ä»¶`);
                
                // å›½ã‚³ãƒ¼ãƒ‰â†’å›½åã®è¾æ›¸
                const countryNames = {
                    'AFG': 'ã‚¢ãƒ•ã‚¬ãƒ‹ã‚¹ã‚¿ãƒ³', 'TUR': 'ãƒˆãƒ«ã‚³', 'DEU': 'ãƒ‰ã‚¤ãƒ„',
                    'PAK': 'ãƒ‘ã‚­ã‚¹ã‚¿ãƒ³', 'UGA': 'ã‚¦ã‚¬ãƒ³ãƒ€', 'USA': 'ã‚¢ãƒ¡ãƒªã‚«åˆè¡†å›½',
                    'FRA': 'ãƒ•ãƒ©ãƒ³ã‚¹', 'ITA': 'ã‚¤ã‚¿ãƒªã‚¢', 'GBR': 'ã‚¤ã‚®ãƒªã‚¹',
                    'CAN': 'ã‚«ãƒŠãƒ€', 'AUS': 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢', 'JPN': 'æ—¥æœ¬',
                    'BRA': 'ãƒ–ãƒ©ã‚¸ãƒ«', 'MEX': 'ãƒ¡ã‚­ã‚·ã‚³', 'ZAF': 'å—ã‚¢ãƒ•ãƒªã‚«',
                    'SYR': 'ã‚·ãƒªã‚¢', 'SDN': 'ã‚¹ãƒ¼ãƒ€ãƒ³', 'IRN': 'ã‚¤ãƒ©ãƒ³',
                    'RUS': 'ãƒ­ã‚·ã‚¢', 'UKR': 'ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠ', 'ETH': 'ã‚¨ãƒã‚ªãƒ”ã‚¢',
                    'COL': 'ã‚³ãƒ­ãƒ³ãƒ“ã‚¢', 'VEN': 'ãƒ™ãƒã‚ºã‚¨ãƒ©', 'KEN': 'ã‚±ãƒ‹ã‚¢',
                    'SSD': 'å—ã‚¹ãƒ¼ãƒ€ãƒ³', 'IRQ': 'ã‚¤ãƒ©ã‚¯', 'JOR': 'ãƒ¨ãƒ«ãƒ€ãƒ³',
                    'LBN': 'ãƒ¬ãƒãƒãƒ³', 'EGY': 'ã‚¨ã‚¸ãƒ—ãƒˆ', 'CHN': 'ä¸­å›½',
                    'IND': 'ã‚¤ãƒ³ãƒ‰', 'IDN': 'ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢', 'THA': 'ã‚¿ã‚¤',
                    'MMR': 'ãƒŸãƒ£ãƒ³ãƒãƒ¼', 'PHL': 'ãƒ•ã‚£ãƒªãƒ”ãƒ³', 'NGA': 'ãƒŠã‚¤ã‚¸ã‚§ãƒªã‚¢',
                    'CMR': 'ã‚«ãƒ¡ãƒ«ãƒ¼ãƒ³', 'TCD': 'ãƒãƒ£ãƒ‰', 'NER': 'ãƒ‹ã‚¸ã‚§ãƒ¼ãƒ«',
                    'DZA': 'ã‚¢ãƒ«ã‚¸ã‚§ãƒªã‚¢', 'MAR': 'ãƒ¢ãƒ­ãƒƒã‚³', 'TUN': 'ãƒãƒ¥ãƒ‹ã‚¸ã‚¢',
                    'LBY': 'ãƒªãƒ“ã‚¢', 'ISR': 'ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«', 'SAU': 'ã‚µã‚¦ã‚¸ã‚¢ãƒ©ãƒ“ã‚¢',
                    'YEM': 'ã‚¤ã‚¨ãƒ¡ãƒ³', 'SOM': 'ã‚½ãƒãƒªã‚¢', 'ERI': 'ã‚¨ãƒªãƒˆãƒªã‚¢'
                };
                
                // å›½ã‚³ãƒ¼ãƒ‰â†’ç·¯åº¦çµŒåº¦ã®è¾æ›¸ï¼ˆä¸»è¦å›½ã®ã¿ã€å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µï¼‰
                const countryCoords = {
                    'AFG': [33.9391, 67.7100], 'TUR': [39.9334, 32.8597], 'DEU': [51.1657, 10.4515],
                    'PAK': [30.3753, 69.3451], 'UGA': [1.3733, 32.2903], 'USA': [37.0902, -95.7129],
                    'FRA': [46.6034, 1.8883], 'ITA': [41.8719, 12.5674], 'GBR': [55.3781, -3.4360],
                    'CAN': [56.1304, -106.3468], 'AUS': [-25.2744, 133.7751], 'JPN': [36.2048, 138.2529],
                    'BRA': [-14.2350, -51.9253], 'MEX': [23.6345, -102.5528], 'ZAF': [-30.5595, 22.9375],
                    'SYR': [34.8021, 38.9968], 'SDN': [12.8628, 30.2176], 'IRN': [32.4279, 53.6880],
                    'RUS': [61.5240, 105.3188], 'UKR': [48.3794, 31.1656], 'ETH': [9.145, 40.4897],
                    'COL': [4.5709, -74.2973], 'VEN': [6.4238, -66.5897], 'KEN': [-1.2921, 36.8219],
                    'SSD': [6.8770, 31.3070], 'IRQ': [33.2232, 43.6793], 'JOR': [30.5852, 36.2384],
                    'LBN': [33.8547, 35.8623], 'EGY': [26.8206, 30.8025], 'CHN': [35.8617, 104.1954],
                    'IND': [20.5937, 78.9629], 'IDN': [-0.7893, 113.9213], 'THA': [15.8700, 100.9925],
                    'MMR': [21.9162, 95.9560], 'PHL': [12.8797, 121.7740], 'NGA': [9.0820, 8.6753],
                    'CMR': [7.3697, 12.3547], 'TCD': [15.4542, 18.7322], 'NER': [17.6078, 8.0817],
                    'DZA': [28.0339, 1.6596], 'MAR': [31.7917, -7.0926], 'TUN': [33.8869, 9.5375],
                    'LBY': [26.3351, 17.2283], 'ISR': [31.0461, 34.8516], 'SAU': [23.8859, 45.0792],
                    'YEM': [15.5527, 48.5164], 'SOM': [5.1521, 46.1996], 'ERI': [15.1794, 39.7823]
                };
                
                // ã‚¢ãƒ¼ã‚¯ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                const arcTraces = [];
                topFlows.forEach(([key, value], idx) => {
                    const [origin, asylum] = key.split('â†’');
                    const oCoord = countryCoords[origin];
                    const aCoord = countryCoords[asylum];
                    if (!oCoord || !aCoord) return;
                    
                    const originName = countryNames[origin] || origin;
                    const asylumName = countryNames[asylum] || asylum;
                    
                    arcTraces.push({
                        type: 'scattergeo',
                        mode: 'lines',
                        lon: [oCoord[1], aCoord[1]],
                        lat: [oCoord[0], aCoord[0]],
                        line: {
                            width: 2 + Math.log10(value) / 2,
                            color: `rgba(${255-idx*20},${99+idx*10},71,0.7)`
                        },
                        opacity: 0.8,
                        hoverinfo: 'text',
                        text: `<b>${originName} â†’ ${asylumName}</b><br>é›£æ°‘æ•°: ${value.toLocaleString()}äºº<br>ç§»å‹•è·é›¢: ${Math.round(calculateDistance(oCoord, aCoord))}km`,
                        hoverlabel: {
                            bgcolor: 'rgba(255,255,255,0.9)',
                            bordercolor: 'rgba(0,0,0,0.5)',
                            font: { size: 14, color: 'black' }
                        }
                    });
                    
                    // å‡ºç™ºç‚¹ã«å††ã‚’æç”»
                    arcTraces.push({
                        type: 'scattergeo',
                        mode: 'markers',
                        lon: [oCoord[1]],
                        lat: [oCoord[0]],
                        marker: {
                            size: 8,
                            color: '#0984e3',
                            line: { width: 1, color: '#fff' }
                        },
                        hoverinfo: 'text',
                        text: `<b>${originName}ï¼ˆå‡ºèº«å›½ï¼‰</b><br>å›½ã‚³ãƒ¼ãƒ‰: ${origin}<br>å‡ºèº«é›£æ°‘æ•°: ${value.toLocaleString()}äºº`,
                        hoverlabel: {
                            bgcolor: 'rgba(9,132,227,0.9)',
                            bordercolor: 'rgba(9,132,227,0.5)',
                            font: { size: 14, color: 'white' }
                        }
                    });
                    
                    // åˆ°ç€ç‚¹ã«å††ã‚’æç”»
                    arcTraces.push({
                        type: 'scattergeo',
                        mode: 'markers',
                        lon: [aCoord[1]],
                        lat: [aCoord[0]],
                        marker: {
                            size: 10,
                            color: '#d35400',
                            line: { width: 1, color: '#fff' }
                        },
                        hoverinfo: 'text',
                        text: `<b>${asylumName}ï¼ˆé¿é›£å…ˆå›½ï¼‰</b><br>å›½ã‚³ãƒ¼ãƒ‰: ${asylum}<br>å—ã‘å…¥ã‚Œé›£æ°‘æ•°: ${value.toLocaleString()}äºº`,
                        hoverlabel: {
                            bgcolor: 'rgba(211,84,0,0.9)',
                            bordercolor: 'rgba(211,84,0,0.5)',
                            font: { size: 14, color: 'white' }
                        }
                    });
                });
                
                const layout = {
                    title: 'ğŸŒ å‡ºèº«å›½â†’é¿é›£å…ˆå›½ã®ç§»å‹•ãƒ•ãƒ­ãƒ¼ï¼ˆä¸Šä½10ï¼‰',
                    showlegend: false,
                    geo: {
                        scope: 'world',
                        projection: { type: 'mercator' },
                        showland: true,
                        landcolor: 'rgb(243, 243, 243)',
                        coastlinecolor: 'rgb(204, 204, 204)',
                        showocean: true,
                        oceancolor: 'rgb(230, 230, 250)',
                        showcountries: true,
                        countrycolor: 'rgb(255, 255, 255)',
                        showframe: false
                    },
                    margin: { l: 0, r: 0, t: 50, b: 0 },
                    height: 700,
                    width: null,
                    autosize: true
                };
                
                Plotly.newPlot('arc-flow', arcTraces, layout, {responsive: true});
                console.log('ã‚¢ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆå®Œäº†');
                
            } catch (error) {
                console.error('ã‚¢ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // 2ç‚¹é–“ã®è·é›¢ã‚’è¨ˆç®—ï¼ˆkmï¼‰
        function calculateDistance(coord1, coord2) {
            const R = 6371; // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
            const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
            const dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.addEventListener('DOMContentLoaded', function() {
            const tabMap = document.getElementById('tab-map');
            const tabFlow = document.getElementById('tab-flow');
            const mainVis = document.getElementById('main-visualization');
            const flowVis = document.getElementById('flow-visualization');
            tabMap.onclick = function() {
                tabMap.style.background = '#0984e3';
                tabFlow.style.background = '#636e72';
                mainVis.style.display = 'block';
                flowVis.style.display = 'none';
            };
            tabFlow.onclick = function() {
                tabMap.style.background = '#636e72';
                tabFlow.style.background = '#0984e3';
                mainVis.style.display = 'none';
                flowVis.style.display = 'block';
                createArcFlow();
            };
        });

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">âŒ ${message}</div>`;
            errorContainer.style.display = 'block';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        window.onload = function() {
            loadCSVData();
        };
    </script>
</body>
</html> 